#!/usr/bin/env python3
# ============================================================
# GHENA PRO AI – SMART CTF LAB ASSISTANT (SIMULATION)
# Single File – Educational / Labs Only
# ============================================================

import sys
import time
import textwrap

# ============================================================
# CONFIG
# ============================================================
SIMULATION_MODE = True   # لا تنفيذ حقيقي
ALLOW_SSH = True         # SSH فقط ببيانات منك
APP_NAME = "GHENA PRO AI"

# ============================================================
# UTIL
# ============================================================
def slow_print(txt, d=0.01):
    for c in txt:
        print(c, end="", flush=True)
        time.sleep(d)
    print()

def banner():
    print("=" * 60)
    print(f"{APP_NAME}".center(60))
    print("Smart CTF / LAB Reasoning Engine".center(60))
    print("=" * 60)

# ============================================================
# AI REASONER (Rule + Logic Based)
# ============================================================
class AIReasoner:
    def analyze(self, stage, output):
        """
        يقرر المرحلة التالية والأداة المناسبة
        """
        output = output.lower()

        if stage == "start":
            return {
                "stage": "recon",
                "tool": "nmap",
                "command": "nmap -sC -sV -Pn <IP>",
                "reason": "Initial service discovery required"
            }

        if "http" in output or "80/tcp" in output or "web" in output:
            return {
                "stage": "enumeration",
                "tool": "gobuster",
                "command": "gobuster dir -u http://<IP> -w /usr/share/wordlists/dirb/common.txt",
                "reason": "Web service detected, directory enumeration needed"
            }

        if "ssh" in output or "22/tcp" in output:
            return {
                "stage": "access",
                "tool": "ssh",
                "command": "ssh <user>@<IP>",
                "reason": "SSH service available, check for valid credentials"
            }

        if "user shell" in output or "logged in" in output:
            return {
                "stage": "privesc",
                "tool": "sudo",
                "command": "sudo -l",
                "reason": "User access achieved, checking sudo privileges"
            }

        if "nopasswd" in output or "all" in output:
            return {
                "stage": "privesc",
                "tool": "root",
                "command": "sudo /bin/bash",
                "reason": "Privilege escalation path identified"
            }

        return {
            "stage": stage,
            "tool": "analysis",
            "command": "manual analysis",
            "reason": "No clear automated path, human decision needed"
        }

# ============================================================
# SIMULATED OUTPUTS (LAB-LIKE)
# ============================================================
def simulated_nmap():
    return """
22/tcp open  ssh     OpenSSH 8.2p1
80/tcp open  http    Apache httpd 2.4.41
"""

def simulated_gobuster():
    return """
/login (Status: 200)
/uploads (Status: 301)
"""

def simulated_ssh_login():
    return """
Logged in as user: www-data
User shell obtained
"""

def simulated_sudo_l():
    return """
User www-data may run the following commands:
(root) NOPASSWD: /usr/bin/python3
"""

# ============================================================
# SSH SESSION (SIMULATED)
# ============================================================
class SSHSession:
    def __init__(self, ip, user):
        self.ip = ip
        self.user = user

    def run(self, cmd):
        if "sudo -l" in cmd:
            return simulated_sudo_l()
        if "bash" in cmd:
            return "Root shell would be obtained here (simulation)."
        return "Command executed (simulation)."

# ============================================================
# MAIN ENGINE
# ============================================================
class GhenaProAI:
    def __init__(self, ip):
        self.ip = ip
        self.stage = "start"
        self.ai = AIReasoner()
        self.ssh = None

    def run(self):
        banner()
        slow_print(f"[+] Target IP: {self.ip}")
        print()

        output = ""
        for step in range(1, 6):
            decision = self.ai.analyze(self.stage, output)

            print("-" * 60)
            print(f"STAGE  : {decision['stage']}")
            print(f"TOOL   : {decision['tool']}")
            print(f"COMMAND: {decision['command'].replace('<IP>', self.ip)}")
            print(f"REASON : {decision['reason']}")
            print("-" * 60)

            cont = input("Execute step? (y/n): ").strip().lower()
            if cont != "y":
                slow_print("Stopped by user.")
                return

            output = self.execute(decision)
            self.stage = decision["stage"]

            if decision["tool"] == "root":
                slow_print("\n[✓] End of lab path (root would be reached here).")
                return

    def execute(self, decision):
        tool = decision["tool"]

        if SIMULATION_MODE:
            if tool == "nmap":
                return simulated_nmap()
            if tool == "gobuster":
                return simulated_gobuster()
            if tool == "ssh":
                user = input("Enter SSH username (simulation): ")
                self.ssh = SSHSession(self.ip, user)
                return simulated_ssh_login()
            if tool in ["sudo", "root"]:
                return self.ssh.run(decision["command"])

        return "Execution skipped."

# ============================================================
# ENTRY
# ============================================================
if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 ghena_pro_ai.py <IP>")
        sys.exit(1)

    ip = sys.argv[1]
    app = GhenaProAI(ip)
    app.run()
